# フィーチャ仕様: ユーザ管理機能の初期提供

**フィーチャブランチ**: `001-add-user-management`  
**作成日**: 2025-10-31  
**ステータス**: ドラフト  
**入力**: ユーザー要求: "ユーザ管理機能を実装する。サインアップ（メールアドレスとパスワードでログイン、SNSログインできるといいかも、メールアドレスがキーならいったんメール認証いれないとあかんかな）、自分だけのユーザホーム（プロフィール、設定など）。初期の簡単なものでＯＫ。ユーザホーム作るならヘッダ、ボディ、フッタ　的なレイアウトも最低限必要かも。"

## ユーザージャーニーとテスト（必須）

> 優先度順（P1, P2, ...）に並べた独立可能なユーザージャーニー。

### ユーザーストーリー 1 - メールサインアップ完了（優先度: P1）

初めて利用する訪問者として、メールアドレスとパスワードでサインアップし、メール認証を完了してから自分のホームに入れるようにしたい。

**優先理由**: 会員基盤の立ち上げに不可欠であり、以降の個別機能の前提になる。

**独立テスト**: 新規メールアドレスで登録 → 認証メールから承認 → 初回ログインでホームが表示されることを自動テストで検証。

**受入シナリオ**:

1. **前提** 登録済みでないメールアドレス、**操作** サインアップフォームでメールとパスワードを送信、**結果** メール認証案内が表示され、確認メールが送信される。  
2. **前提** 認証メール内リンクが有効、**操作** 利用者がリンクを開く、**結果** アカウントが有効化されログイン画面に遷移する。  
3. **前提** 有効化済みアカウント、**操作** メールアドレスとパスワードでログイン、**結果** 自分のユーザホームが表示される。

---

### ユーザーストーリー 2 - サインインとサインアウト（優先度: P1）

既に登録済みのユーザとして、いつでもサインインしてホームを表示でき、不要になったら安全にサインアウトしたい。

**優先理由**: 日常的な利用の起点であり、セッション管理・セキュリティに直結する。

**独立テスト**: 有効化済みアカウントでログイン → 指定のセッション継続時間内でホームが再表示 → サインアウト後に保護ページへアクセスするとログインを要求されることを検証。

**受入シナリオ**:

1. **前提** 有効なアカウント、**操作** ログインフォームで認証情報を送信、**結果** ホームが表示される。  
2. **前提** ログイン状態、**操作** サインアウト操作を行う、**結果** セッションが失効しログインページへ遷移する。  
3. **前提** サインアウト済み、**操作** ホーム URL に再アクセス、**結果** ログインを求められる。

---

### ユーザーストーリー 3 - プロフィール編集（優先度: P2）

会員として、表示名やアイコンなどのプロフィール情報を編集して自分のホームをカスタマイズしたい。

**優先理由**: 個人化体験の基礎となり、ユーザーデータの初期収集にも役立つ。

**独立テスト**: ホームのプロフィール編集画面で項目変更 → 保存 → ホームに反映 → 再ログイン後も反映されていることを検証。

**受入シナリオ**:

1. **前提** ログイン済み、**操作** プロフィール編集画面で表示名と自己紹介を更新、**結果** 保存成功メッセージと更新内容がホームに反映される。  
2. **前提** 無効なファイル形式のアイコン、**操作** アップロード、**結果** 適切なエラーメッセージが表示され保存されない。

---

### ユーザーストーリー 4 - 設定更新（優先度: P2）

会員として、通知受信や表示言語などの基本設定を自分で切り替えたい。

**優先理由**: ユーザー自律性と運用コスト低減に寄与する。

**独立テスト**: 設定画面で通知オプションを変更 → 保存 → 即時反映 → 次回ログイン時も設定が維持されることを検証。

**受入シナリオ**:

1. **前提** ログイン済み、**操作** 設定でメール通知をオフに切り替え、**結果** 保存成功と UI 表示が更新される。  
2. **前提** ログイン済み、**操作** 表示言語を変更、**結果** ホームの固定文言が選択言語に切り替わる。

## エッジケース

- 既に登録済みのメールアドレスでサインアップを試みた場合は登録を拒否し、ログインへの導線を提示する。
- 認証メールの有効期限切れ・多重リクエストには再送オプションを提供し、期限切れリンク利用時は明示的に案内する。
- 認証前ユーザがログインしようとした場合は「メール認証未完了」の案内を表示し再送リンクを提示する。
- パスワード入力エラーが一定回数を超えた場合は短時間のロックを行い、ロック解除手段を提示する。
- プロフィール・設定更新時に未入力／不正値がある場合は保存せず、該当フィールドごとにエラーを表示する。
- セッションタイムアウト後に操作した場合はログインページへリダイレクトし、入力内容を失わないよう確認する。

## 要件（必須）

### 機能要件

- **FR-001**: システムはメールアドレスとパスワードでのサインアップフォームを提供し、入力値を即時バリデーションすること。  
- **FR-002**: システムはサインアップ後にメールアドレス宛へ確認メールを送信し、リンク経由でアカウントを有効化できること。  
- **FR-003**: システムは有効化済みユーザがメールアドレスとパスワードでログインできるフォームを提供し、成功時にホームへ遷移させること。  
- **FR-004**: システムはログイン状態をセッションとして保持し、一定時間（初期値: 30 分）操作がない場合は自動的にサインアウトさせること。  
- **FR-005**: システムはサインアウト操作を提供し、実行時にセッションを失効させてログインページへ遷移させること。  
- **FR-006**: システムはユーザホームをヘッダ・ボディ・フッタの 3 領域で構成し、ログインユーザ固有のプロフィール情報・設定概要を表示すること。  
- **FR-007**: システムはプロフィール編集機能を提供し、表示名・自己紹介・アイコン画像を更新して即時にホームへ反映すること。  
- **FR-008**: システムは設定編集機能を提供し、通知受信可否・表示言語・タイムゾーンを変更・保存し、次回ログイン時にも反映すること。  
- **FR-009**: システムは認証前ユーザがログインした場合に「メール認証未完了」のメッセージと再送リンクを提示すること。  
- **FR-010**: システムは無効な入力（重複メール、形式不正、パスワード強度不足等）に対して具体的なエラーメッセージを表示すること。

### ドメインエンティティと値オブジェクト

- **UserAccount（集約ルート）**: ID、EmailAddress、PasswordCredential、Profile、Settings、VerificationStatus を保持し、サインアップ・有効化・ログイン可否判定・サインアウトなどの振る舞いを提供する。  
- **EmailAddress（値オブジェクト）**: RFC 5322 準拠の書式検証、ドメイン許可リスト（必要時）、大文字小文字正規化を行う。  
- **PasswordCredential（値オブジェクト）**: 最低 12 文字・英大小・数字の複合要件を検証し、ハッシュ化前提の値として扱う（生パスワードの直接保持は禁止）。  
- **Profile（値オブジェクト）**: DisplayName、Bio、AvatarImage を含み、文字数・ファイル形式・サイズ制約を管理する。  
- **UserSettings（値オブジェクト）**: NotificationPreference、Locale、TimeZone を含み、許容値範囲を強制する。  
- **VerificationToken（値オブジェクト）**: トークン値、有効期限、利用回数を管理し、期限切れ判定を提供する。

### アプリケーションサービスとポート

- **SignUpService**: 入力バリデーション、UserAccount 生成、有効化メール送信を仲介する。  
- **AuthService**: 認証、セッション発行、サインアウト、ロックアウト制御を行う。  
- **ProfileService / SettingsService**: プロフィール・設定の更新とドメインイベント発火を仲介する。  
- **メール送信ポート**: 認証メール・通知の送信。  
- **ファイルストレージポート**: アイコン画像の保存・参照を仲介する。  
- **セッションポート**: セッション生成・失効を管理する。  
- CQRS 方針: 書き込みはドメイン集約を通じてイベント保存、読み取りは専用リードモデルを利用する。

### コマンド & クエリモデル

- **SignUpCommand（集約メソッド）**: EmailAddress、PasswordCredential を受け取り、UserAccount 作成・VerificationToken 発行・GroupEvent: AccountCreated を返す。  
- **VerifyAccountCommand**: VerificationToken を検証し、AccountVerified イベントを発行する。  
- **SignInCommand**: EmailAddress、PasswordCredential を検証し、成功時に SessionIssued イベントを発行する。  
- **UpdateProfileCommand**: Profile 値を受け取り、ProfileUpdated イベントを発生させる。  
- **UpdateSettingsCommand**: UserSettings を更新し、SettingsUpdated イベントを発生させる。  
- **UserHomeQuery**: 認証済みユーザ ID をキーに、プロフィール情報・設定・最近の通知を返す。  
- **AccountStatusQuery**: 認証状態（未認証・有効・ロック中）を返す。

### イベント設計

- **AccountCreated**: aggregateId、EmailAddress、VerificationToken、発行時刻を保持。  
- **AccountVerified**: aggregateId、VerifiedAt を保持。  
- **SessionIssued**: aggregateId、SessionId、発行時刻、有効期限を保持。  
- **ProfileUpdated**: aggregateId、更新前後の差分を保持。  
- **SettingsUpdated**: aggregateId、変更内容を保持。  
- イベント順序は aggregateId 単位で保証し、リードモデルはイベントストリームを順次処理する。

### イベントストア構成

- `j5ik2o/event-store-adapter-rs` を利用し、DynamoDB のジャーナル・スナップショットテーブル構成に従う。  
- スナップショット間隔は 50 イベントを初期値とし、再生時間を短縮する。  
- 監視指標として書き込み成功率・トークン再送件数・セッション発行件数を計測する。  
- 参考実装は `references/event-store-adapter-rs` と `references/cqrs-es-example-rs/modules/command/domain` を参照し、差異は仕様に記録する。  
- DynamoDB Streams をトリガーとする Event Forwarder Lambda（`applications/event-forwarder`）が Kinesis Data Streams へイベントを転送し、保持期間を確保した上で下流（RMU や将来のマイクロサービス）に配信する。  

### クラウド運用とローカル検証

- 本番環境は AWS（DynamoDB、SES、S3、Lambda 等）を利用し、LocalStack で同等構成を再現する。  
- イベントバスは AWS Kinesis Data Streams を利用し、Account* イベントを購読してリードモデル更新・通知送信を行う。  
- IaC は AWS CDK を採用し、メール送信・ストレージ・イベントストア設定をコード化する。  
- CI は docker compose + LocalStack 上でサインアップ→認証→ログイン→プロフィール更新の E2E パスを検証する。

### リポジトリ構成と依存制御

- `modules/command/*`, `modules/query/*`, `modules/rmu` それぞれの依存方向を一方向に制約する。  
- TypeScript プロジェクトリファレンスと ESLint/biome ルールで逆依存が発生した場合にビルドエラーとする。  
- 参考レイアウトとの差異がある場合は plan.md で理由と対策を明記する。

### リポジトリとアダプタ

- リポジトリインターフェイスは UserAccount, Session, VerificationToken を対象とする。  
- インメモリ実装はユニットテストで利用し、DynamoDB 実装はインターフェースアダプタ層に配置する。  
- メール送信、ファイルストレージ、セッション管理は外部依存を抽象化したポート経由で行う。  
- 参考として `references/cqrs-es-example-rs/modules/command/interface-adaptor-impl` を参照しつつコピーは行わない。

### 開発順序上の前提

1. 値オブジェクト・集約のテストと実装 → 2. リードモデル設計 → 3. メール送信・ファイル保存ポート実装 → 4. GraphQL リゾルバ整備 → 5. UI 統合テスト。  
2. Primitive Obsession を避けるため、フォーム入力からドメイン型へ変換するレイヤーを設ける。  
3. エラー分類（入力エラー / 認証未完了 / ロックアウト / サーバエラー）を仕様内で統一し、UI メッセージも共通化する。

## 成功指標（必須）

### 測定可能な成果

- **SC-001**: 新規訪問者の 80% が 5 分以内にサインアップとメール認証を完了できる。  
- **SC-002**: ログイン済みユーザの 90% が 10 秒以内にプロフィール変更を完了し、即座にホームへ反映される。  
- **SC-003**: 月間アクティブユーザの 95% がセッションタイムアウトによる再ログイン時に最新プロフィール/設定を維持している。  
- **SC-004**: サポート経由の「ログインできない」「プロフィールが更新されない」といった問い合わせが初期リリース後 4 週間で週 5 件未満に収まる。

## Assumptions

- 初期リリースでは SNS ログインは導入せず、メール+パスワードとメール認証のみ提供する。  
- パスワードリセット機能は後続スプリントで対応し、本仕様では導線のみ提示する。  
- プロフィールアイコンは 2MB 以下の PNG/JPEG、通知設定はメール通知のオン/オフのみを初期セットとして提供する。

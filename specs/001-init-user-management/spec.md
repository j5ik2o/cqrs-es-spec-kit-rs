# Feature Specification: ユーザ管理基盤初期構築

**Feature Branch**: `001-init-user-management`  
**Created**: 2025-11-01  
**Status**: Draft  
**Input**: ユーザ要求: "まずゼロからなので基盤実装を整えて、最低限の機能を提供する。どんなアプリケーションでも必要なユーザ管理機能はほしい。サインアップと退会。自ユーザ確認画面。管理者がユーザ管理できる画面。ユーザ機能と管理者機能は一つのNext.jsでもよいけどモジュールをわけてほしい。"

## ユーザシナリオとテスト *(必須)*

### User Story 1 - セルフサインアップとプロフィール確認 (Priority: P1)

新規訪問者として登録し、自分の基本情報を確認できることでサービス利用を開始したい。

**優先度の理由**: 登録開始ができないと他の機能が成立せず、初期価値提供が阻害されるため。

**独立したテスト方法**: 未登録状態からサインアップ→確認メール承認→マイページ表示までの一連の操作が完了することをエンドツーエンドテストで検証する。

**受け入れシナリオ**:

1. **Given** 未登録の訪問者がサインアップ画面を開いている, **When** 必須項目（氏名、メールアドレス、パスワード）を入力して利用規約に同意する, **Then** 新規アカウントが作成され確認手順案内が表示される。
2. **Given** サインアップを完了しメール認証を済ませた利用者がログイン済みである, **When** 自分のプロフィール画面を開く, **Then** 登録時に入力した氏名・メールアドレス・登録日時が閲覧でき更新履歴が表示される。

---

### User Story 2 - 自主退会の完了 (Priority: P2)

利用者として、不要になった際に自分で退会手続きを完了し個人情報の扱いを把握したい。

**優先度の理由**: 法令順守とユーザ信頼維持のために基本的な自己決定権を早期に提供する必要がある。

**独立したテスト方法**: 既存ユーザが退会操作を実行し、手続き完了通知とアカウント無効化を確認するテストケースを構築する。

**受け入れシナリオ**:

1. **Given** 有効な利用者がログインしてマイページにいる, **When** 退会ボタンを選択し、確認ダイアログで「退会する」を確定する, **Then** アカウントが無効化され、登録メール宛に退会完了通知が送られ以後ログインできなくなる。

---

### User Story 3 - 管理者によるユーザ状況管理 (Priority: P3)

運用担当管理者として、登録ユーザの状態を把握し必要に応じて無効化や再開などの対応を行いたい。

**優先度の理由**: 初期段階では利用者向け機能優先だが、早期にガバナンスを確立しサポート問い合わせに備える必要がある。

**独立したテスト方法**: 管理者アカウントでログインし、一覧表示・詳細閲覧・ステータス変更・監査記録出力を操作するテストを実施する。

**受け入れシナリオ**:

1. **Given** 管理者が管理コンソールにログインしている, **When** ユーザ一覧を検索し特定の利用者詳細を開いてアカウント状態を一時停止に変更する, **Then** 対象利用者の状態が即時に更新され、監査ログに管理者ID・変更理由・変更時刻が記録される。

---

### 例外・境界ケース

- 既に登録済みのメールアドレスでサインアップが試行された場合は重複登録を拒否し、登録済みである旨と次のアクション（ログイン/パスワード再設定）を案内する。
- 認証手続きが完了していない利用者はプロフィール閲覧や退会ができず、完了手順をガイドする。
- 退会後の再登録を一定期間制限する場合のメッセージおよびデータ保持期間を明示し、関連通知に整合させる。
- 管理者は他の管理者アカウントを変更できず、自身の状態変更は別プロセスに委ねることで職権濫用を防止する。
- ユーザデータの更新は BFF 経由でキューイングされ、イベントストアと読みモデルの整合が保てない場合は管理者に警告を表示し再実行手順を案内する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは訪問者がメールアドレス・氏名・パスワードを入力して利用規約に同意することで新規ユーザ登録を完了できるセルフサインアップ手続きを提供しなければならない。
- **FR-002**: システムは入力されたメールアドレスの重複を防ぎ、パスワード強度ポリシー（最低文字数と複雑性）および利用規約同意の確認を行わなければならない。
- **FR-003**: システムは登録完了後にメール認証リンクを送付し、リンクが承認されるまではログインやプロフィール操作を制限しなければならない。
- **FR-004**: システムはログイン済み利用者が自身のプロフィール（氏名、メールアドレス、登録日、アカウント状態）を閲覧し、最新情報が表示されていることを確認できる画面を提供しなければならない。
- **FR-005**: システムは利用者がマイページから退会手続きを開始し、確認フローを経た後にアカウントを無効化して以後のログインを拒否し、法令で許容される範囲のデータ保持方針を通知しなければならない。
- **FR-006**: システムは退会完了時およびサインアップ完了時に利用者へ通知を送り、アカウント状態の変化を明示的に伝えなければならない。
- **FR-007**: システムは管理者専用モジュールでユーザ一覧の検索・フィルタ・ソートと個別詳細の閲覧、状態変更（有効化、一時停止、退会済みの表示）を実行できるようにしなければならない。
- **FR-008**: システムは管理者によるユーザ状態変更や退会処理を監査ログとして記録し、操作した管理者、変更内容、理由、タイムスタンプを保持しなければならない。
- **FR-009**: システムはユーザ機能モジュールと管理者機能モジュールの画面およびナビゲーションを分離し、誤操作や権限逸脱を防ぐためにアクセス制御を適用しなければならない。

### 主要エンティティ *(データを扱う場合は必須)*

- **EndUserAccount**: 利用者の識別子、メールアドレス、氏名、アカウント状態（仮登録・有効・一時停止・退会済み）、登録日時、最終更新日時、メール認証状況を保持する。
- **AdminAccount**: 管理者の識別子、氏名、連絡先、権限ロール、最終ログインを保持し、管理者モジュールへのアクセス制御に利用される。
- **AccountStatusAuditLog**: アカウント状態変更の履歴を記録し、対象ユーザ、操作した管理者またはシステム主体、変更前後の状態、理由、発生日時、通知送信結果を保存する。
- **UserNotification**: サインアップ・退会・状態変更に伴い利用者へ送付された通知の種別、送信先、送信結果、再送回数、関連イベントIDを管理する。

## 前提条件・仮定

- サインアップはメールアドレスとパスワードを用いる標準的な Web 認証フローを採用し、ソーシャルログインは後続フェーズとする。
- 退会後のデータ保持は 30 日以内のアカウント復元要求に備えて最低限の監査情報のみ保持し、それ以降は個人を特定できない形で統計情報に限定する。
- 管理者アカウントの発行は既存運用プロセスで実施され、本機能では登録 UI を持たない。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 新規訪問者がサインアップ開始からメール認証完了までの平均所要時間が 10 分以内であること（通知遅延含む）。
- **SC-002**: サインアップ完了後に初回ログインしプロフィールを確認できる利用者の成功率が 95% 以上であること。
- **SC-003**: 退会手続きが完了し 5 分以内にアカウント無効化と通知送信が行われるケースが 99% 以上であること。
- **SC-004**: 管理者のユーザ状態変更操作が 1 分以内に読みモデルへ反映され、監査ログ出力の欠落が 0 件であること。
- **SC-005**: 利用者と管理者の誤ったモジュールアクセス試行がアクセス制御で阻止され、そのログが 100% 記録されること。

---

description: "フィーチャ実装のためのタスクテンプレート"
---

# タスク: [FEATURE NAME]

**入力**: `/specs/[###-feature-name]/` 配下のドキュメント  
**事前条件**: plan.md（必須）、spec.md（必須）、research.md、data-model.md、contracts/

**テスト**: テストタスクは必須。各ユースケースの単体・契約・統合テストを先に追加し、回復可能・回復不能エラーの扱いを含めて実装前に失敗させる。

**編成方針**: タスクはユーザーストーリー単位にグルーピングし、独立した実装・テスト・デプロイを可能にする。

## 表記形式: `[ID] [P?] [Story] 説明`

- **[P]**: 並列実行可能（異なるファイルで依存関係なし）の場合に付与する。
- **[Story]**: 対応するユーザーストーリー。例: US1, US2, US3。
- 説明には正確なファイルパスを記載する。

## パス規約

- **標準構成**: `packages/command/domain/src`, `packages/command/processor/src`, `packages/command/interface-adaptor-impl/src`, `packages/query/interface-adaptor/src`, `packages/rmu/src`
- **ワークスペース**: ルートの `packages/` 配下にサブプロジェクトを配置し、`references/cqrs-es-example-js/packages` の階層と整合させる（pnpm + turbo で登録）。
- **テスト**: 共通の `tests/` ディレクトリまたは各パッケージ直下の `__tests__` を活用し、ユニット/契約/統合テストをレイヤーごとに配置する。
- plan.md の構成方針と矛盾しないよう必要に応じて修正する。

<!--
  ============================================================================
  注意: 以下のタスクはサンプル。/speckit.tasks コマンドは実際の仕様に合わせて生成する。
  - spec.md のユーザーストーリー（優先度を含む）
  - plan.md の技術方針
  - data-model.md のエンティティ
  - contracts/ の契約
  を反映し、ユーザーストーリーごとに独立した MVP を構築できること。
  ============================================================================
-->

## フェーズ1: セットアップ（共通基盤）

**目的**: プロジェクト構造とツールチェーンの初期化

- [ ] T001 実装計画に沿ってディレクトリと基盤コードを整備する
- [ ] T002 選定したフレームワークと依存ライブラリを導入する
- [ ] T003 [P] Lint/フォーマッタ/型チェックを設定する

---

## フェーズ2: 基盤整備（全ユースケースの前提）

**目的**: すべてのユースケース実装前に必要なアプリケーション・インフラ基盤を構築する

**⚠️ 重要**: このフェーズが完了するまでユーザーストーリー実装を開始してはならない。

- [ ] T004 ユースケース共通のドメインエンティティ・値オブジェクトを定義する（Primitive Obsession を避け、数量・金額などは専用の値オブジェクトで表現する）
- [ ] T005 [P] アプリケーションサービスのポート・例外方針を確立する
- [ ] T006 [P] 永続化・API などのアダプタ骨格を作成する
- [ ] T007 監査ログ・トレースなど横断的関心事を組み込む
- [ ] T008 環境変数管理・設定読み込みの仕組みを整え、AWS 向け設定と LocalStack/docker compose の切り替えを用意する
- [ ] T009 インメモリリポジトリを `packages/command/interface-adaptor-impl/src/repository/in-memory` に実装し、ユースケーステストから利用できるようにする
- [ ] T010 インフラストラクチャ共通ユーティリティ（ロギング・設定・ID 生成など）を `infrastructure/` 以下に整備する（IO を含めない）
- [ ] T011 [P] `@j5ik2o/event-store-adapter-js` の接続設定を `infrastructure/` に実装し、AWS 上の本番構成と LocalStack 用 docker compose 設定を整備する
- [ ] T012 イベント投影/サブスクライバの基盤（Kinesis を用いたイベントバス・リードモデル更新）を用意し、LocalStack での再生テストを含めユニットテストで再生可能にする
- [ ] T013 エラーハンドリング方針をドキュメントに反映し、回復可能/不能の分類と戻り値型・例外境界を明記する
- [ ] T014 `references/event-store-adapter-js` と `references/cqrs-es-example-js` をレビューし、設計意図のみ参照して差分を記録（コードのコピーや改変取り込みは禁止）。CQRS のクエリ側がドメインモデル・リポジトリへ依存せずリードデータベースへ直接アクセスする設計になっているか確認する
- [ ] T015 GraphQL サーバのベース（スキーマ、サーバ起動、ドメイン層との結線）を `backend/graphql/` 等に構築し、Mutation/Query/Subscription をユースケースにバインドする
- [ ] T016 Next.js API Routes に BFF 基盤を用意し、GraphQL クライアント構成・セッション/トークン管理・監査ログフックを実装する
- [ ] T017 Next.js プレゼンテーション層の土台（レイアウト、データ取得フック、GraphQL クライアント生成）を準備し、BFF 経由でデータ取得できることを確認する
- [ ] T018 DynamoDB（コマンド側）用のテーブル構成・Terraform/CDK 定義を作成し、LocalStack で動作確認する
- [ ] T019 MySQL リードモデル用のスキーマとマイグレーション基盤を整備し、docker compose で起動する
- [ ] T020 Read Model Updater を AWS Lambda として雛形実装し、Kinesis トリガ/ローカル実行（SAM 等）の手順を用意する
- [ ] T021 DynamoDB のジャーナル/スナップショットテーブル形式を `references/cqrs-es-example-js/tools/dynamodb-setup/create-tables.sh` と照合し、差分がある場合は仕様・計画・タスクへ記録する
- [ ] T022 pnpm のワークスペース設定を構築し、`packages/` 配下を `references/cqrs-es-example-js/packages` に倣った構造で作成する
- [ ] T023 TypeScript プロジェクトリファレンス・ESLint/biome ルール・ビルドタスクで層の逆依存が発生すると失敗する仕組みを導入する
- [ ] T024 GraphQL アクセス用の共通トークン管理・クライアントモジュールを `packages/application` 等に定義し、API Routes/RSC から再利用できるようにする
- [ ] T025 BFF(API Routes) と RSC の双方で共通モジュールを利用する統合テストを追加し、直接トークンを扱う実装が存在しないことを確認する

**チェックポイント**: 基盤が整い、各ユースケースが独立に着手可能になった状態。

---

## フェーズ3: ユーザーストーリー 1 - [タイトル]（優先度: P1）🎯 MVP

**ゴール**: [このストーリーが提供する価値を簡潔に記述]

**独立テスト方法**: [単体で検証する手順]

### テスト（必須）

> **重要**: 以下のテストタスクを先に実装し、失敗することを確認してから機能を実装する。

- [ ] T026 [P] [US1] ドメイン単体テストを `tests/unit/` に追加する（回復可能エラーと正常系を検証）
- [ ] T027 [P] [US1] ポート契約テストを `tests/contract/` に追加する（例外変換を含む）
- [ ] T028 [P] [US1] 統合テストを `tests/integration/` に追加する（外部エラー伝播と代替フローを検証）

### 実装

- [ ] T029 [P] [US1] ドメインモデルを `packages/command/domain/src/...` に追加する（集約メソッドをコマンドとして実装し、独立したコマンドクラスを作成しない）
- [ ] T030 [P] [US1] ユースケースサービスを `packages/command/processor/src/...` に実装する（Either/Result によるエラー制御を含む）
- [ ] T031 [US1] アダプタを `packages/command/interface-adaptor-impl/src/...` に実装し、ポートを満たす（例外をドメイン向けエラーに変換し、RPC/DB/イベントストア連携など Gateway 責務を担う）
- [ ] T032 [US1] バリデーション・エラーハンドリングを組み込む（回復不能エラーはフェイルファスト）
- [ ] T033 [US1] 観測性（ログ・メトリクス）を追加する
- [ ] T034 [US1] ドメインサービスが純粋関数であること、およびリファレンスコードをコピーしていないことをレビューする
- [ ] T035 [US1] コマンドハンドラがイベント保存を主目的に設計され、必要最小限のリプレイ・他集約確認に限定して読み込みを行っていることを確認する
- [ ] T036 [US1] バリデータが値オブジェクトのコンストラクタ経由で検証し、成功時は値オブジェクトを返し失敗時はエラーを返していることを確認する
- [ ] T037 [US1] GraphQL スキーマにユースケース専用 Mutation/Query/Subscription を追加し、ドメインサービスと結線する（対応するドメインイベントを `packages/command/domain/src/...-events.ts` に定義する）
- [ ] T038 [US1] Next.js API Route を実装し、UI からの入力検証・GraphQL 呼び出し・レスポンス整形を行う
- [ ] T039 [US1] Next.js UI コンポーネントを実装し、BFF 経由でデータ取得・GraphQL サブスクリプション受信・エラー表示を行う

**チェックポイント**: ユーザーストーリー 1 が単独でデプロイ・検証可能になった状態。

---

## フェーズ4: ユーザーストーリー 2 - [タイトル]（優先度: P2）

**ゴール**: [提供価値]

**独立テスト方法**: [検証手順]

### テスト（必須）

- [ ] T040 [P] [US2] ドメイン単体テストを `tests/unit/` に追加する
- [ ] T041 [P] [US2] 契約テストを `tests/contract/` に追加する
- [ ] T042 [P] [US2] 統合テストを `tests/integration/` に追加する

### 実装

- [ ] T043 [P] [US2] 必要なドメインオブジェクトを拡張する（集約メソッドとしてコマンドを実装し、独立したコマンドクラスを作成しない）
- [ ] T044 [US2] ユースケースサービスを追加・調整する（エラー戻り値を拡張）
- [ ] T045 [US2] インターフェイスアダプタを実装し、US1 との衝突を確認する（例外変換と通知。RPC/DB/イベントストア連携はこちらで実装）
- [ ] T046 [US2] 監査ログや追跡情報を更新する（エラー計測を含む）
- [ ] T047 [US2] ドメインサービスの純粋性をテストし、永続化依存やリファレンスコードのコピーが混入していないことを検証する
- [ ] T048 [US2] コマンドハンドラの読み込みがリプレイ/他集約確認など最小限の目的に限定されていることをレビューし、クエリ責務へ逸脱していないことを確認する
- [ ] T049 [US2] バリデータが値オブジェクトのコンストラクタ経由で検証し、成功時は値オブジェクトを返し失敗時はエラーを返していることを確認する
- [ ] T050 [US2] GraphQL スキーマ/リゾルバを拡張し、新しいユースケースを Mutation/Query/Subscription に反映する（対応するドメインイベントを `packages/command/domain/src/...-events.ts` に追加する）
- [ ] T051 [US2] Next.js API Route を拡張し、追加データ型・エラーを BFF で吸収する
- [ ] T052 [US2] Next.js UI を拡張し、リアルタイム更新や UX 変更を実装する

**チェックポイント**: ユーザーストーリー 1 と 2 が互いに独立動作し、受入条件を満たす。

---

## フェーズ5: ユーザーストーリー 3 - [タイトル]（優先度: P3）

**ゴール**: [提供価値]

**独立テスト方法**: [検証手順]

### テスト（必須）

- [ ] T052 [P] [US3] ドメイン単体テストを `tests/unit/` に追加する
- [ ] T053 [P] [US3] 契約テストを `tests/contract/` に追加する
- [ ] T054 [P] [US3] 統合テストを `tests/integration/` に追加する

### 実装

- [ ] T055 [P] [US3] ドメインモデル・ユースケースを拡張する（新しいエラー型を定義し、コマンドは集約メソッドとして実装する）
- [ ] T056 [US3] インターフェイスアダプタを実装する（外部エラーをマッピングし、RPC/DB/イベントストア連携を提供）
- [ ] T057 [US3] 監視・メトリクスを更新する（エラー指標を追加）
- [ ] T058 [US3] ドメインサービスで外部依存が追加されていないか、リファレンスコードがコピーされていないかを静的解析・レビューで確認する
- [ ] T059 [US3] コマンドフロー全体をリプレイし、読み込みが許容範囲に収まっていることとクエリ責務へ逸脱していないことを検証する
- [ ] T060 [US3] バリデータが値オブジェクトのコンストラクタ経由で検証し、成功時は値オブジェクトを返し失敗時はエラーを返していることを確認する
- [ ] T061 [US3] GraphQL リゾルバ・スキーマを拡張し、サブスクリプションや Mutation の追加分を反映する（新しいドメインイベントを `packages/command/domain/src/...-events.ts` に追加する）
- [ ] T062 [US3] Next.js API Route を更新し、新しいユースケースの入力検証・レスポンス整形・エラーマッピングを追加する
- [ ] T063 [US3] Next.js UI を更新し、BFF 経由での新しい体験やリアルタイム更新を実装・テストする

**チェックポイント**: すべてのユーザーストーリーが独立稼働できる状態。

---

[必要に応じて追加のユーザーストーリーフェーズを定義する]

---

## フェーズN: 仕上げと横断的対応

**目的**: 全ユースケースにまたがる改善

- [ ] TXXX [P] ドキュメント（quickstart, README 等）を更新する
- [ ] TXXX クリーンアーキテクチャの依存方向が守られているかレビューし、違反箇所を是正する
- [ ] TXXX コードの整備とリファクタリングを行う
- [ ] TXXX 性能検証と最適化を行う
- [ ] TXXX イベントストアのリプレイ・スナップショット手順を検証し、ドキュメントと整合させる
- [ ] TXXX [P] 追加のユニットテストを `tests/unit/` に追加する
- [ ] TXXX セキュリティ診断・ハードニングを実施する
- [ ] TXXX quickstart.md の手順を実際に検証する

---

## 依存関係と実行順序

### フェーズ間依存

- **セットアップ（フェーズ1）**: 依存なし。即時着手可。
- **基盤整備（フェーズ2）**: フェーズ1完了が前提。全ユースケースのブロッカー。
- **ユーザーストーリー（フェーズ3以降）**: フェーズ2完了後に開始。必要なら並列実施。
- **仕上げ（最終フェーズ）**: 目標とするユーザーストーリー完了後に実施。

### ユーザーストーリー間依存

- **US1 (P1)**: フェーズ2完了後に着手。ほかのストーリーへの依存なし。
- **US2 (P2)**: フェーズ2完了後に着手。US1 と連携する場合は契約で明示する。
- **US3 (P3)**: フェーズ2完了後に着手。既存ストーリーとの競合をテストで保証する。

### 各ユーザーストーリー内の順序

- テストを先に記述し、失敗を確認してから実装する。
- ドメインモデル → ユースケースサービス → アダプタ実装の順で進める。
- バリデーションと例外処理をまとめて検証する。
- インターフェースアダプタはユースケース経由でのみドメインへアクセスすることを確認する。
- ストーリー完了前にドキュメント更新とレビュー準備を行う。

### 並列実行のヒント

- `[P]` が付いたセットアップ・基盤タスクはファイルの競合がない範囲で並列化できる。
- 同一ユーザーストーリー内でもファイルが独立していれば `[P]` タスクを並列に実施可能。
- 異なるユーザーストーリーは共通基盤が整備されていれば別担当者で進められる。

---

## 並列実行例: ユーザーストーリー 1

```bash
# ユーザーストーリー1のテストを一括で失敗させる
Task: "ドメイン単体テストを tests/unit/test_[name].ts に追加"
Task: "契約テストを tests/contract/test_[name].ts に追加"
Task: "統合テストを tests/integration/test_[name].ts に追加"

# ユーザーストーリー1のドメインモデルを並列で実装
Task: "値オブジェクトを packages/command/domain/src/value-objects/[name].ts に追加"
Task: "エンティティを packages/command/domain/src/entities/[name].ts に追加"
Task: "ユースケースサービスを packages/command/processor/src/[use-case]/[name].ts に実装"
Task: "アダプタを packages/command/interface-adaptor-impl/src/[adapter]/[name].ts に実装（ユースケース経由でドメインへ）"
```

---

## 実装戦略

### MVP ファースト（ユーザーストーリー1のみ）

1. フェーズ1（セットアップ）を完了する。
2. フェーズ2（基盤整備）を完了し、インメモリリポジトリとインフラユーティリティを整備する。
3. フェーズ3（ユーザーストーリー1）を完了する。
4. **検証**: US1 のテストを全て実行し、仕様と一致することを確認。
5. 準備が整えばデプロイ / デモを行う。

### インクリメンタルデリバリー

1. セットアップと基盤整備を完了し、基盤を固定する。
2. US1 を追加 → テスト → デプロイ / デモ。
3. US2 を追加 → テスト → デプロイ / デモ。
4. US3 を追加 → テスト → デプロイ / デモ。
5. 各ストーリーで価値を追加しつつ既存機能を維持する。

### チーム並列戦略

1. チーム全員でフェーズ1・2を完了させ共通基盤を固める。
2. 基盤整備完了後:
   - 開発者A: US1
   - 開発者B: US2
   - 開発者C: US3
3. ストーリー毎に独立テストとドキュメント更新を完了させる。

---

## メモ

- `[P]` タスク = 依存関係が無く並列実行可能。
- `[Story]` ラベルでストーリー単位のトレーサビリティを確保する。
- 各ストーリーは単独で完成・テストできる状態に保つ。
- テストは必ず先に実装し、失敗を確認してから機能実装に進む。
- コミットはタスク単位または論理的なまとまりで行い、関連仕様を参照する。
- 憲章原則（DDD 層構造、仕様ドリブン、テストファースト、ドキュメント同期）に適合しないタスクは正当化し記録する。
